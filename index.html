<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂëΩËøê‰πãÂ≤õ - Project Destiny ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin-reverse { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
        .animate-spin-reverse { animation: spin-reverse 1.5s linear infinite; }
        @keyframes float-large { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-30px) rotate(1deg); } }
        .animate-float-large { animation: float-large 8s ease-in-out infinite; }
        
        @keyframes flare-breathe {
            0%, 100% { opacity: 0.3; transform: scale(1); filter: blur(40px); }
            50% { opacity: 0.6; transform: scale(1.2); filter: blur(60px); }
        }
        .animate-flare { animation: flare-breathe 4s ease-in-out infinite; }

        @keyframes mesh-motion {
            0% { background-position: 0% 50%, 50% 0%, 100% 50%, 50% 100%; }
            50% { background-position: 100% 50%, 50% 100%, 0% 50%, 50% 0%; }
            100% { background-position: 0% 50%, 50% 0%, 100% 50%, 50% 100%; }
        }

        #init-white-mask {
            position: fixed; inset: 0; background: #fff; z-index: 1000;
            pointer-events: none; transition: opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #hourglass-overlay {
            position: fixed; inset: 0; background: #fff; z-index: 1001;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; 
            transition: opacity 2s ease, filter 1.5s ease;
        }
        .hourglass-svg { width: 100px; height: 140px; filter: drop-shadow(0 0 15px rgba(30, 58, 138, 0.2)); }
        .hg-frame { fill: none; stroke: #1e3a8a; stroke-width: 1.5; stroke-linecap: round; }
        .hg-water { fill: #2563eb; }
        
        @keyframes water-drop {
            0% { stroke-dashoffset: 40; opacity: 0; }
            30% { opacity: 1; }
            100% { stroke-dashoffset: 0; opacity: 0.7; }
        }
        .hg-stream {
            stroke: #2563eb; stroke-width: 2.5; stroke-dasharray: 4, 10;
            animation: water-drop 0.45s linear infinite;
        }

        body { 
            background-color: #0f172a;
            color: white; 
            overflow-x: hidden; 
            font-family: system-ui, -apple-system, sans-serif; 
            margin: 0; padding: 0; min-height: 100vh;
        }

        #bg-canvas, #bg-final, #step0-bg, #deconstructed-bg-canvas { position: fixed; inset: 0; pointer-events: none; }
        #bg-canvas {
            z-index: -3;
            background-image: 
                radial-gradient(circle at 20% 30%, #1e293b 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, #334155 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, #2c3e50 0%, transparent 60%),
                radial-gradient(circle at 90% 90%, #1a202c 0%, transparent 40%);
            background-size: 200% 200%;
            animation: mesh-motion 25s ease-in-out infinite;
            transition: opacity 1.8s ease-in-out;
        }
        #bg-final {
            z-index: -1;
            opacity: 0;
            transition: opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #deconstructed-bg-canvas {
            z-index: -1.5;
            opacity: 0;
            transition: opacity 3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: blur(15px); 
        }

        #step0-bg {
            z-index: -2;
            opacity: 0;
            transition: opacity 3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(to bottom, #020617, #0f172a);
            overflow: hidden;
        }
        #step0-bg.show-bg { opacity: 1; }
        .aurora {
            position: absolute; top: -20%; left: -10%; width: 120%; height: 60%;
            background: radial-gradient(ellipse at 50% 50%, rgba(13, 148, 136, 0.15) 0%, transparent 70%);
            filter: blur(60px); opacity: 0.5; animation: aurora-move 20s infinite alternate;
        }
        @keyframes aurora-move { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(5%, 10%) scale(1.1); } }
        .film-grain {
            position: absolute; inset: 0; opacity: 0.04; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        .breathing-glow { animation: glow-breathe 4s ease-in-out infinite; }
        @keyframes glow-breathe { 0%, 100% { opacity: 0.3; filter: brightness(1); } 50% { opacity: 0.6; filter: brightness(1.5); } }

        .step-container { 
            display: none; 
            opacity: 0; 
            filter: blur(30px); 
            width: 100%; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            transition: opacity 2s cubic-bezier(0.2, 0.8, 0.2, 1), 
                        filter 2s cubic-bezier(0.2, 0.8, 0.2, 1), 
                        transform 2s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform: scale(0.96); 
            position: relative;
            z-index: 10;
            will-change: opacity, filter, transform;
        }
        .step-container.active { 
            display: flex; 
            opacity: 1; 
            filter: blur(0px); 
            transform: scale(1); 
        }
        
        .reveal-anim { transition: opacity 4s cubic-bezier(0.4, 0, 0.2, 1), filter 4s cubic-bezier(0.4, 0, 0.2, 1) !important; }

        #ripple-container { position: fixed; inset: 0; z-index: 500; pointer-events: none; }
        @keyframes ripple-out {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; filter: blur(15px); border-width: 20px; }
            20% { opacity: 0.34; filter: blur(2px); }
            60% { opacity: 0.18; filter: blur(4px); }
            100% { transform: translate(-50%, -50%) scale(6.5); opacity: 0; filter: blur(15px); border-width: 1px; }
        }
        @keyframes ripple-in {
            0% { transform: translate(-50%, -50%) scale(6.5); opacity: 0; filter: blur(15px); border-width: 1px; }
            40% { opacity: 0.34; filter: blur(2px); }
            80% { opacity: 0.18; filter: blur(4px); }
            100% { transform: translate(-50%, -50%) scale(0); opacity: 0; filter: blur(15px); border-width: 20px; }
        }
        .ripple { position: absolute; top: 50%; left: 50%; border-radius: 50%; border-style: solid; border-color: rgba(255, 255, 255, 0.34); transform-origin: center center; }

        #bubble-container { position: fixed; inset: 0; z-index: 5; pointer-events: none; overflow: hidden; }
        .bubble {
            position: absolute; bottom: -150px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.5) 0%, rgba(255, 255, 255, 0.02) 70%);
            box-shadow: inset -3px -3px 8px rgba(255,255,255,0.15), 0 0 15px rgba(255,255,255,0.08);
            border-radius: 50%; pointer-events: none; will-change: transform, opacity;
            backdrop-filter: blur(2px);
        }
        @keyframes bubble-rise {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            15% { opacity: 0.8; }
            85% { opacity: 0.6; }
            100% { transform: translateY(-135vh) translateX(var(--sway, 0)); opacity: 0; }
        }

        .back-btn, #music-toggle {
            position: fixed; top: 32px; z-index: 110;
            width: 52px; height: 52px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(15px); color: inherit;
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer;
        }
        .back-btn { left: 32px; }
        #music-toggle { right: 32px; opacity: 0; pointer-events: none; }
        #music-toggle.visible { opacity: 1; pointer-events: auto; }
        
        .back-btn svg, #music-toggle svg { width: 22px; height: 22px; pointer-events: none; }
        .back-btn:hover, #music-toggle:hover { background: white; color: #0f172a; transform: scale(1.1); box-shadow: 0 0 25px rgba(255,255,255,0.2); }
        
        body.light-mode { color: #1e293b !important; }
        body.light-mode .back-btn, body.light-mode #music-toggle { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); color: #1e293b; }
        body.light-mode .back-btn:hover, body.light-mode #music-toggle:hover { background: #1e293b; color: #fff; }

        #loading-overlay { z-index: 200; pointer-events: none; }
        
        .circle-title-group { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; text-align: center; pointer-events: none; width: 100%; }
        #altar-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 700px; height: 700px; pointer-events: none; }
        #altar-ring > div { pointer-events: auto; }
        .orbital-line { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 0.5px solid rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none; }

        #error-modal {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: #fee2e2; border-left: 4px solid #ef4444; color: #b91c1c;
            padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(120%); transition: transform 0.5s ease;
        }
        #error-modal.show { transform: translateX(0); }

        #progress-bar { top: 58px; }
        .progress-dot {
            height: 2px; width: 44px; background-color: rgba(255, 255, 255, 0.1);
            border-radius: 999px; transition: all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center;
        }
        .progress-dot.active { background-color: rgba(255, 255, 255, 1); box-shadow: 0 0 12px rgba(255, 255, 255, 0.6); transform: scale(1.1, 2.2); }
        .progress-dot.completed { background-color: rgba(255, 255, 255, 0.45); }
        body.light-mode .progress-dot { background-color: rgba(0, 0, 0, 0.05); }
        body.light-mode .progress-dot.active { background-color: rgba(0, 0, 0, 0.9); box-shadow: 0 0 8px rgba(0, 0, 0, 0.1); }
        body.light-mode .progress-dot.completed { background-color: rgba(0, 0, 0, 0.2); }

        .token-slot {
            width: 140px; height: 140px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.02); transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; cursor: pointer;
        }
        .token-slot:hover { 
            border-color: rgba(255,255,255,0.8); 
            background: rgba(255,255,255,0.1); 
            transform: scale(1.12) translateY(-6px); 
            box-shadow: 0 15px 50px rgba(0,0,0,0.4), 0 0 30px rgba(255,255,255,0.15);
            filter: brightness(1.15);
        }
        
        .token-slot.active { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.8); box-shadow: 0 0 35px rgba(255,255,255,0.2); }
        .token-slot.active .main-icon { display: none; } 
        .token-slot.active .slot-label { 
            font-size: 14px; color: #fff; font-weight: 500; transform: scale(1.2); 
            text-shadow: 0 0 15px rgba(255,255,255,0.9); opacity: 1;
        }

        .token-slot .close-btn { 
            position: absolute; top: 10px; right: 10px; width: 26px; height: 26px; 
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15); 
            border-radius: 50%; display: none; align-items: center; justify-content: center; 
            transition: all 0.3s ease; z-index: 30; backdrop-filter: blur(4px);
        }
        .token-slot .close-btn:hover { background: rgba(239, 68, 68, 0.8); transform: scale(1.1); border-color: transparent; }
        .token-slot.active .close-btn { display: flex; }
        
        .token-slot .slot-label { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
        .token-slot:hover .slot-label { transform: scale(1.15); color: rgba(255, 255, 255, 0.85); text-shadow: 0 0 12px rgba(255, 255, 255, 0.4); font-weight: 500; }
        .token-slot:hover .main-icon { color: rgba(255, 255, 255, 0.4); filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.2)); }
        
        #proceed-trigger { opacity: 0.2; pointer-events: none; transition: all 0.8s; }
        #proceed-trigger.ready { opacity: 1; pointer-events: auto; transform: translateY(0); }

        .media-layer { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 2s ease-in-out; pointer-events: none; }

        /* ‰øÆÊîπÁÇπ 1Ôºö‰∫∫ÁîüÂú∞ÂΩ¢ËèúÂçï - Êõ¥Âº∫ÁöÑÊØõÁéªÁíÉÊÑü‰∏éÂ∞∫ÂØ∏‰ºòÂåñ */
        #topology-menu {
            position: fixed;
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 32px;
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 16px;
            z-index: 10000;
            box-shadow: 0 40px 100px rgba(0,0,0,0.7), inset 0 0 0 1px rgba(255,255,255,0.1);
            transform: translate(-50%, -100%);
            animation: menu-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            min-width: 280px;
        }
        
        @keyframes menu-pop { from { opacity: 0; scale: 0.6; } to { opacity: 1; scale: 1; } }
        @keyframes menu-hide { from { opacity: 1; scale: 1; } to { opacity: 0; scale: 0.4; } }
        .menu-hiding { animation: menu-hide 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards !important; }

        .menu-icons-row { display: flex; gap: 10px; justify-content: center; }
        .menu-item {
            width: 52px; height: 52px; border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s; color: rgba(255,255,255,0.4);
            position: relative; border: 1px solid transparent;
        }
        .menu-item svg { width: 28px; height: 28px; transition: transform 0.3s; } /* ‰øÆÊîπÁÇπ 2ÔºöÂõæÊ†áÊîæÂ§ß */
        .menu-item:hover, .menu-item.selected { 
            background: rgba(255, 255, 255, 0.15); 
            color: white; 
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-4px); 
        }
        .menu-item .label { 
            position: absolute; bottom: -24px; font-size: 11px; /* ‰øÆÊîπÁÇπ 2ÔºöÂ≠óÁº©Â∞è */
            white-space: nowrap; opacity: 0; transition: opacity 0.3s;
            letter-spacing: 0.1em; font-weight: 300; font-style: italic;
        }
        .menu-item:hover .label { opacity: 1; }

        #topology-input-area { display: none; flex-direction: column; gap: 14px; padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 12px; }
        #topology-input-area p { font-size: 11px; color: rgba(255,255,255,0.6); font-style: italic; line-height: 1.6; text-align: center; }
        #topology-input-field { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; color: white; font-size: 13px; outline: none; transition: all 0.3s; text-align: center; }
        #topology-confirm-btn { background: white; color: #0f172a; border-radius: 14px; padding: 12px; font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.2em; cursor: pointer; transition: all 0.3s; text-align: center; }

        /* ÊãìÊâëËäÇÁÇπÊ†∑Âºè */
        .topology-node-group { cursor: grab; pointer-events: auto; }
        .topology-node-group:active { cursor: grabbing; }
        .topology-label-text { 
            pointer-events: none; 
            font-size: 8.5px; /* ‰øÆÊîπÁÇπ 2ÔºöÂ≠óÁº©Â∞è */
            font-weight: 300; 
            font-style: italic; 
            fill: rgba(255,255,255,0.5); 
            text-anchor: middle; 
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .topology-node-group:hover .topology-label-text { fill: rgba(255,255,255,1); font-size: 11px; filter: brightness(1.5); }
        .topology-node-group:hover .topology-node { filter: brightness(1.8); }

        /* ÁâπÊÆäËΩ¨Âú∫ÔºöÁ∫∏Êù°ÁïåÈù¢ */
        #note-transition-overlay {
            position: fixed; inset: 0; z-index: 50000;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(0px);
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #destiny-note {
            background: #fffef0; color: #1e293b;
            padding: 50px; border-radius: 2px; width: 380px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            transform: rotate(-1.5deg); position: relative;
            font-family: "Noto Serif SC", serif; font-style: italic; text-align: center; line-height: 2;
            opacity: 1; transition: all 2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #note-content { font-size: 1.25rem; color: #334155; margin-bottom: 20px; font-weight: 500; }
        .wave-svg { position: absolute; bottom: 0; left: 0; width: 100%; height: 0; transition: height 2.5s ease-in-out; pointer-events: none; z-index: 10; }
    </style>
</head>
<body id="main-body">

    <div id="error-modal" onclick="this.classList.remove('show')">
        <strong class="block text-sm">ÊèêÁ§∫</strong>
        <span id="error-text" class="text-[10px] opacity-80"></span>
    </div>

    <div id="bubble-container"></div>

    <div id="hourglass-overlay">
        <svg class="hourglass-svg" viewBox="0 0 100 140">
            <path class="hg-frame" d="M20,10 L80,10 M20,130 L80,130 M30,10 Q50,70 30,130 M70,10 Q50,70 70,130"></path> 
            <g clip-path="url(#clip-top-natural)">
                <path class="hg-water" d="M30,10 Q50,70 70,10 Z"></path>
            </g>
            <g clip-path="url(#clip-bottom-natural)">
                <path class="hg-water" d="M30,130 Q50,70 70,130 Z"></path>
            </g>
            <line class="hg-stream" x1="50" y1="68" x2="50" y2="128"></line> 
            <defs>
                <clipPath id="clip-top-natural">
                    <rect x="0" y="10" width="100" height="60">
                        <animate attributeName="y" from="10" to="70" dur="4s" fill="freeze" />
                        <animate attributeName="height" from="60" to="0" dur="4s" fill="freeze" />
                    </rect>
                </clipPath>
                <clipPath id="clip-bottom-natural">
                    <rect x="0" y="130" width="100" height="0">
                        <animate attributeName="y" from="130" to="70" dur="4s" fill="freeze" />
                        <animate attributeName="height" from="0" to="60" dur="4s" fill="freeze" />
                    </rect>
                </clipPath>
            </defs>
        </svg>
        <p class="mt-10 text-[9px] tracking-[1em] uppercase font-light text-blue-900 animate-pulse">Wait for Origin</p>
    </div>

    <div id="init-white-mask"></div>

    <div id="step0-bg">
        <div class="aurora"></div>
        <svg class="absolute inset-0 w-full h-full" preserveAspectRatio="xMidYMid slice" viewBox="0 0 1000 600">
            <g id="stars-group"></g>
            <path d="M0,450 L150,380 L300,420 L500,350 L700,400 L850,320 L1000,400 L1000,600 L0,600 Z" fill="#0f172a" opacity="0.4" />
            <path d="M0,480 L200,420 L400,460 L600,380 L800,440 L1000,400 L1000,600 L0,600 Z" fill="#1e293b" opacity="0.6" />
            <path d="M0,520 L250,460 L500,500 L750,440 L1000,500 L1000,600 L0,600 Z" fill="#020617" />
            <g fill="#020617">
                <path d="M100,520 L115,460 L130,520 Z" /> <path d="M110,480 L120,440 L130,480 Z" />
                <path d="M850,510 L865,440 L880,510 Z" /> <path d="M860,460 L870,420 L880,460 Z" />
                <path d="M420,500 Q425,490 435,490 L445,490 Q450,490 450,500 L448,510 L442,510 Z M445,490 Q450,480 445,470" stroke="#020617" stroke-width="2" fill="none" />
            </g>
            <path d="M500,600 C450,580 550,565 500,540 S560,515 525,485" fill="none" stroke="url(#roadGradient)" stroke-width="4" stroke-dasharray="2,6" />
            <path d="M500,600 C450,580 550,565 500,540 S560,515 525,485" fill="none" stroke="#60a5fa" stroke-width="2" opacity="0.3" class="breathing-glow" />
            <circle cx="525" cy="485" r="4" fill="#60a5fa" class="breathing-glow">
                <animate attributeName="r" values="4;8;4" dur="3s" repeatCount="indefinite" />
            </circle>
            <defs>
                <linearGradient id="roadGradient" x1="0" y1="1" x2="0" y2="0">
                    <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.9" />
                    <stop offset="60%" stop-color="#60a5fa" stop-opacity="0.4" />
                    <stop offset="100%" stop-color="#334155" stop-opacity="0" />
                </linearGradient>
            </defs>
        </svg>
        <div class="film-grain"></div>
    </div>

    <div id="bg-canvas"></div>
    <div id="bg-final"></div>
    <canvas id="deconstructed-bg-canvas"></canvas>

    <button id="global-back" onclick="goBack()" class="back-btn hidden">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
            <path d="M19 12H5M12 19l-7-7 7-7"></path>
        </svg>
    </button>

    <div id="music-toggle" onclick="toggleMusic()">
        <svg id="music-icon-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
        <svg id="music-icon-off" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
    </div>

    <div id="ripple-container"></div>

    <div id="progress-bar" class="fixed left-1/2 -translate-x-1/2 flex gap-4 z-50 transition-opacity duration-1000">
        <div class="progress-dot" id="dot-0"></div><div class="progress-dot" id="dot-1"></div>
        <div class="progress-dot" id="dot-2"></div><div class="progress-dot" id="dot-3"></div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center bg-slate-950/90 backdrop-blur-2xl">
        <div class="absolute w-64 h-64 bg-blue-500/10 rounded-full animate-flare"></div>
        <div class="relative w-32 h-32 flex items-center justify-center">
            <div class="absolute inset-0 border-[0.5px] border-white/10 rounded-full animate-[spin_10s_linear_infinite]"></div>
            <div class="absolute inset-2 border-t-[1.5px] border-blue-400/80 rounded-full animate-[spin_1.5s_cubic-bezier(0.4,0,0.2,1)_infinite]" style="filter: drop-shadow(0 0 15px rgba(96, 165, 250, 0.6));"></div>
            <div class="absolute inset-2 border-r-[0.5px] border-white/20 rounded-full animate-[spin_3s_linear_infinite]"></div>
            <div class="absolute w-1 h-1 bg-white rounded-full shadow-[0_0_20px_4px_rgba(255,255,255,0.8)] animate-pulse"></div>
            <svg class="w-7 h-7 text-white/90 animate-pulse relative z-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
            </svg>
        </div>
        <p id="loading-text" class="mt-8 text-[9px] tracking-[1.5em] uppercase font-light text-blue-300/50">Resonating</p>
    </div>

    <!-- ËΩ¨Âú∫ÂâØÊú¨ÁïåÈù¢ -->
    <div id="note-transition-overlay">
        <div id="destiny-note">
            <p id="note-content"></p>
            <div class="mt-12 flex flex-col gap-5">
                <button onclick="washMemory()" class="px-10 py-4 border border-slate-200 text-slate-400 rounded-full text-[10px] tracking-[0.2em] uppercase hover:bg-slate-50 transition-all font-light">ËÆ©Êµ∑Ê∞¥ÂÜ≤Âà∑</button>
                <button onclick="lightMemory()" class="px-10 py-4 bg-slate-900 text-white rounded-full text-[10px] tracking-[0.3em] uppercase shadow-2xl hover:scale-105 transition-all font-bold">ÁÇπ‰∫ÆËÆ∞ÂøÜ</button>
            </div>
            <svg class="wave-svg" viewBox="0 0 400 100" preserveAspectRatio="none">
                <path id="wave-path" d="M0,100 C150,100 250,100 400,100 L400,100 L0,100 Z" fill="rgba(37, 99, 235, 0.45)"></path>
            </svg>
        </div>
    </div>

    <main class="relative flex flex-col items-center justify-center min-h-screen">
        <div id="topology-menu">
            <div class="menu-icons-row">
                <div class="menu-item" onclick="prepareDestinyNode('circle')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>
                    <span class="label">Èô™‰º¥</span>
                </div>
                <div class="menu-item" onclick="prepareDestinyNode('star')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    <span class="label">ÂêØÂèë</span>
                </div>
                <div class="menu-item" onclick="prepareDestinyNode('triangle')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4l9 16H3z"/></svg>
                    <span class="label">ÊøÄÂä±</span>
                </div>
                <div class="menu-item" onclick="prepareDestinyNode('quad')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                    <span class="label">Ê≤ªÊÑà</span>
                </div>
                <div class="menu-item" onclick="prepareDestinyNode('harm')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21L3 4h18z"/></svg>
                    <span class="label">‰º§ÂÆ≥</span>
                </div>
                <div class="menu-item" onclick="prepareDestinyNode('custom')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 12l8 10 8-10z"/></svg>
                    <span class="label">Ëá™ÂÆö‰πâ</span>
                </div>
            </div>
            <div id="topology-input-area">
                <p id="topology-input-prompt"></p>
                <input type="text" id="topology-input-field" placeholder="ÈïåÂàª‰Ω†ÁöÑÁóïËøπ..." maxlength="20">
                <div id="topology-confirm-btn" onclick="finalizeDestinyNode()">Á°ÆËÆ§ÈÄªËæë</div>
            </div>
        </div>

        <div id="step-0" class="step-container flex-col items-center space-y-12">
            <div class="text-center space-y-4">
                <h1 class="text-5xl font-extralight tracking-[0.4em] uppercase">Âú∞Ë¥®Ê∫ØÊ∫ê</h1>
                <p class="text-white/40 text-[10px] tracking-[0.6em] uppercase italic">Genesis of Consciousness</p>
            </div>
            <div class="flex gap-8">
                <div id="slot-0" class="token-slot group" onclick="triggerUpload(0)">
                    <div class="close-btn" onclick="clearSlot(event, 0)">
                        <svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 18l12-12"></path></svg>
                    </div>
                    <svg class="main-icon w-8 h-8 text-white/10 mb-2 transition-colors duration-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M12 2v20M2 12h20"></path></svg>
                    <span class="text-[9px] tracking-[0.2em] text-white/20 uppercase pl-[0.2em] slot-label">ÊäïÊîæÁîüÂëΩ‰ø°Áâ©</span>
                    <input type="file" id="upload-0" class="hidden" onchange="handleFileChange(0)">
                </div>
                <div id="slot-1" class="token-slot group" onclick="triggerUpload(1)">
                    <div class="close-btn" onclick="clearSlot(event, 1)">
                        <svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 18l12-12"></path></svg>
                    </div>
                    <svg class="main-icon w-8 h-8 text-white/10 mb-2 transition-colors duration-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M12 2v20M2 12h20"></path></svg>
                    <span class="text-[9px] tracking-[0.2em] text-white/20 uppercase pl-[0.2em] slot-label">ÊäïÊîæÁîüÂëΩ‰ø°Áâ©</span>
                    <input type="file" id="upload-1" class="hidden" onchange="handleFileChange(1)">
                </div>
                <div id="slot-2" class="token-slot group" onclick="triggerUpload(2)">
                    <div class="close-btn" onclick="clearSlot(event, 2)">
                        <svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 18l12-12"></path></svg>
                    </div>
                    <svg class="main-icon w-8 h-8 text-white/10 mb-2 transition-colors duration-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M12 2v20M2 12h20"></path></svg>
                    <span class="text-[9px] tracking-[0.2em] text-white/20 uppercase pl-[0.2em] slot-label">ÊäïÊîæÁîüÂëΩ‰ø°Áâ©</span>
                    <input type="file" id="upload-2" class="hidden" onchange="handleFileChange(2)">
                </div>
            </div>
            <div id="proceed-trigger" onclick="processStep(0)" class="flex flex-col items-center cursor-pointer group translate-y-4">
                <div class="w-20 h-20 border border-white/20 rounded-full flex items-center justify-center bg-white/[0.05] group-hover:scale-110 transition-all duration-500 shadow-xl group-hover:bg-white group-hover:border-white">
                    <svg class="w-8 h-8 text-white/40 group-hover:text-slate-900 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M5 12h14M12 5l7 7-7 7"></path>
                    </svg>
                </div>
                <span class="mt-4 text-[10px] tracking-[0.6em] text-white/30 uppercase pl-[0.6em] font-light group-hover:text-white transition-colors">ÂºÄÂêØ‰ª™Âºè</span>
            </div>
        </div>

        <div id="step-1" class="step-container flex-col items-center space-y-16">
            <h2 class="text-4xl font-extralight tracking-[0.4em] uppercase">Ê∞îÂÄô‰ª™Âºè</h2>
            <div class="w-[520px] space-y-12">
                <p id="climate-question" class="text-white/60 text-sm text-center font-light italic leading-relaxed h-12"></p>
                <div id="climate-options" class="grid grid-cols-1 gap-5"></div>
            </div>
        </div>

        <div id="step-2" class="step-container flex-col items-center space-y-16">
            <h2 class="text-4xl font-extralight tracking-[0.4em] uppercase text-white/80">‰∫∫ÁîüÂú∞ÂΩ¢</h2>
            <div class="relative w-[520px] h-[520px] border border-white/10 rounded-[5rem] bg-white/[0.02] shadow-2xl" id="topology-box" style="overflow: visible;">
                <div id="topology-hint" class="absolute inset-0 flex flex-col items-center justify-center space-y-4 opacity-40">
                    <svg class="w-12 h-12 text-white/30 animate-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M12 2v20M2 12h20"></path></svg>
                    <p class="text-[10px] tracking-[0.4em] uppercase font-light">ÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÔºåÊèèÁªò‰Ω†ÁöÑÂëΩËøêËΩ®Ëøπ</p>
                </div>
                <svg id="topology-svg" class="absolute inset-0 w-full h-full opacity-60 pointer-events-auto"></svg>
            </div>
            <button id="topo-activate-btn" onclick="triggerStep2Process()" class="px-20 py-5 bg-white/5 border border-white/10 text-white/20 rounded-full text-[10px] tracking-[0.8em] font-bold uppercase transition-all shadow-xl pointer-events-none">ÊøÄÊ¥ªÈÄªËæëÂú∞ÂΩ¢</button>
        </div>

        <div id="step-3" class="step-container w-full h-screen flex-col items-center justify-center bg-transparent overflow-hidden">
            <div class="relative w-[700px] h-[700px]">
                <div class="orbital-line w-[620px] h-[620px]"></div><div class="orbital-line w-[480px] h-[480px] opacity-50"></div>
                <div class="circle-title-group"><h2 class="text-5xl font-extralight tracking-[0.5em] uppercase text-white">ÂëΩËøê‰πãÁéØ</h2><p class="text-[10px] tracking-[1.2em] text-white/30 mt-4 uppercase font-light">Circle of Destiny</p></div>
                <div id="altar-ring"></div>
            </div>
        </div>

        <div id="step-4" class="step-container w-full max-w-7xl flex-col items-center justify-center min-h-screen py-24 reveal-anim">
            <div class="absolute top-12 left-12 flex items-center gap-6 opacity-30"><div class="w-20 h-[1px] bg-current"></div><span class="text-[11px] tracking-[0.6em] uppercase font-bold text-current">Life Island // Project Destiny</span></div>
            <div class="grid grid-cols-1 lg:grid-cols-12 w-full items-center gap-20 px-12 relative z-10 -translate-y-12">
                <div class="lg:col-span-4 lg:text-left text-center space-y-10">
                    <div class="space-y-4">
                        <p id="island-theme-label" class="opacity-40 text-[12px] tracking-[0.5em] uppercase font-light"></p>
                        <h2 id="island-name" class="text-7xl font-extralight tracking-tighter leading-[1.1] italic">...</h2>
                    </div>
                    <div class="space-y-6">
                        <p id="island-desc" class="opacity-70 font-light text-base leading-relaxed italic max-w-sm"></p>
                    </div>
                    <div class="flex flex-col gap-6 text-[11px] tracking-[0.3em] opacity-40 font-mono"><div>COORD <span id="island-coord">SCANNING...</span></div><div>SPIRIT <span id="island-spirit">SLEEPING...</span></div></div>
                </div>
                <div class="lg:col-span-8 relative flex flex-col items-center justify-center min-h-[750px]">
                    <div id="visual-frame" class="relative group w-full flex justify-center items-center h-[550px]">
                        <div id="reified-image" class="absolute inset-0 z-20 rounded-full overflow-hidden opacity-0 transition-opacity duration-[2s] border-[12px] border-white shadow-2xl scale-[1.05]"></div>
                        <div id="island-visual" class="relative z-10 scale-[1.1] animate-float-large transition-all duration-[2.5s]"></div>
                    </div>
                    <div id="result-controls" class="flex flex-wrap justify-center gap-8 pt-40 z-20">
                        <button onclick="reset()" class="px-14 py-5 border border-black/10 rounded-full text-black/40 hover:text-black transition-all text-[11px] tracking-[0.5em] uppercase font-bold">RESTART</button>
                        <button id="reify-btn" onclick="reifyStageOne()" class="px-20 py-5 bg-slate-900 text-white rounded-full text-[11px] tracking-[0.5em] uppercase font-bold shadow-2xl hover:scale-110 transition-all">‚ú® ÂÖ∑Ë±°ÂåñÁîªÂç∑</button>
                        <button id="stereo-btn" onclick="reifyStageTwo()" class="hidden px-20 py-5 bg-blue-600 text-white rounded-full text-[11px] tracking-[0.5em] uppercase font-bold shadow-2xl hover:scale-110 transition-all">üåÄ Á´ã‰ΩìÂåñÁîªÂç∑</button>
                        <button id="cancel-stereo-btn" onclick="reifyStageOne(true)" class="hidden px-20 py-5 border-2 border-slate-900 text-slate-900 rounded-full text-[11px] tracking-[0.5em] uppercase font-bold hover:bg-slate-900 hover:text-white transition-all">üîô ÂèñÊ∂àÁ´ã‰ΩìÂåñ</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const islandTypes = [
            { id: 'ember_island', name: 'ÁÉ¨ÂúüÁÇéÊ¥≤', theme: 'warm', themeName: 'ÈªÑÁ∫¢ÔºöÁÇΩÁÉà‰∏éÁªöÁÉÇ', color: '#ef4444', sec: '#7f1d1d', icon: 'üåã', desc: 'Â≤õÂ±øÈÅçÂ∏ÉÂÜ∑Âç¥ÁöÑÁÜîÂ≤©ÁÑ¶ÂúüÔºåÊ≤üÂ£ë‰∏≠ÊµÅÊ∑åÁùÄÁÇΩÁÉ≠ÁöÑÁÜîÂ≤©Ê≤≥ÔºåÊòØÁÅ´ÁÑ∞‰∏éÈáçÁîüÁöÑÂõΩÂ∫¶„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\jintuyanzhou.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\jintuyanzhou.mp4' },
            { id: 'maple_cliff', name: 'Ëµ§Êû´ÊöÆÂ¥ñ', theme: 'warm', themeName: 'ÈªÑÁ∫¢ÔºöÁÇΩÁÉà‰∏éÁªöÁÉÇ', color: '#f97316', sec: '#7c2d12', icon: 'üçÅ', desc: 'È´òËÄ∏ÁöÑÊÇ¨Â¥ñ‰∏äÁîüÊª°Â¶ÇÁÅ´ÁÑ∞Ëà¨ÁöÑÊû´ÊûóÔºåÊØèÂΩìÊöÆËâ≤Èôç‰∏¥ÔºåÊû´Âè∂„ÄÅÊôöÈúû‰∏éÁÜîÂ≤©ÁöÑÂæÆÂÖâ‰∫§ËûçÔºåÂ§©Âú∞‰∏ÄÁâáËµ§Á∫¢„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\chifengmuya.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\chifengmuya.mp4' },
            { id: 'violet_valley', name: 'Á¥´Ê±êÁÅµË∞∑', theme: 'mystic', themeName: 'Á≤âÁ¥´ÔºöÊ¢¶Âπª‰∏éÂπΩÁßò', color: '#ec4899', sec: '#831843', icon: 'üå∏', desc: 'Ëä±ÊúµÁöÑËâ≤Ê≥Ω‰ºöÂ¶ÇÊΩÆÊ±êËà¨Âú®Á≤âÁ¥´Èó¥ÊØèÊó•ËßÑÂæãÂèòÂåñÔºåÂΩ¢ÊàêÊüîÂíåÁöÑ‚ÄúËâ≤ÂΩ©ÊΩÆÊ±ê‚ÄùÔºåÂÖÖÊª°ÁÅµÂä®ÁöÑÁîüÂëΩÂäõ„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\zixilinggu.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\zixilinggu.mp4' },
            { id: 'starry_field', name: 'ÂπΩÊòôÊòüÂéü', theme: 'mystic', themeName: 'Á≤âÁ¥´ÔºöÊ¢¶Âπª‰∏éÂπΩÁßò', color: '#a855f7', sec: '#581c87', icon: '‚ú®', desc: '‰∏ÄÁßçÂ¶ÇÁéâÊòôËà¨ÁöÑÂ∑®Â§ßËä±ÊúµÂú®Â§úÊôöÈõÜ‰ΩìÁªΩÊîæÔºåÊï£ÂèëÂá∫ÊòüËæâËà¨ÁöÑÊ∑°Á¥´ÂÖâËäíÔºåÂ∞ÜËçâÂéüÁÇπÁºÄÊàêÊòüÁ©∫ÂÄíÂΩ±„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\youtanxingyuan.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\youtanxingyuan.mp4' },
            { id: 'dream_mist', name: 'ÁªÆÊ¢¶ÈõæÊµ∑', theme: 'mystic', themeName: 'Á≤âÁ¥´ÔºöÊ¢¶Âπª‰∏éÂπΩÁßò', color: '#d946ef', sec: '#701a75', icon: 'üå´Ô∏è', desc: 'Ê∞∏Áª≠ÁöÑÊ∑°Á¥´Ëâ≤ËñÑÈõæÁ¨ºÁΩ©Â≤õÂ±øÔºåÂÖ∂‰∏≠ÁîüÈïøÁùÄÂ∑®Â§ßÁöÑÂèëÂÖâËä±ÂçâÔºåËôöÂÆûÈöæËæ®Ôºå‰ªø‰ΩõË°åËµ∞Âú®‰ªñ‰∫∫Ê¢¶‰∏≠„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\qimengwuhai.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\qimengwuhai.mp4' },
            { id: 'floating_forest', name: 'Ê£ÆÊÅØÊµÆÂ±ø', theme: 'nature', themeName: 'ÁªøËâ≤ÔºöÁîüÊú∫‰∏éÁßòÂ¢É', color: '#10b981', sec: '#064e3b', icon: 'üåø', desc: 'Áî±ÁõòÊ†πÈîôËäÇÁöÑÂè§Ê†ëÊ†πÁ≥ªÊâòËµ∑ÁöÑÁ©∫‰∏≠Ê£ÆÊûóÂ≤õÂ±øÔºå‰∫ëÈõæÁº≠ÁªïÔºåÊòØÊ∞îÊÅØÁªµÈïøÁöÑÁîüÂëΩÂáÄÂúü„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\senxifuyu.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\senxifuyu.mp4' },
            { id: 'melody_prairie', name: 'ÂçÉÁ±ÅËçâÂéü', theme: 'nature', themeName: 'ÁªøËâ≤ÔºöÁîüÊú∫‰∏éÁßòÂ¢É', color: '#84cc16', sec: '#365314', icon: 'üçÉ', desc: 'ÊØè‰∏ÄÁâáËçâÂè∂ÈÉΩËÉΩÂú®È£é‰∏≠ÂèëÂá∫ÁªÜÂæÆ‰πêÈü≥ÔºåÊï¥ÁâáËçâÂéüÂ∞±ÊòØÊ¥ªÁöÑ‰πêÂô®ÔºåÂ•èÂìçÊ∞∏‰∏çÂÅúÊÅØÁöÑËá™ÁÑ∂‰∫§ÂìçËØó„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\qianlaicaoyuan.jpg', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\qianlaicaoyuan.mp4' },
            { id: 'ice_abyss', name: 'Ê∞∏ÂØÇÂÜ∞Ê∏ä', theme: 'cool', themeName: 'ËìùËâ≤ÔºöÂáõÂÜΩ‰∏éÊ∑±ÈÇÉ', color: '#3b82f6', sec: '#1e3a8a', icon: '‚ùÑÔ∏è', desc: 'Â∑®Â§ßÁöÑËìùËâ≤ÂÜ∞Â∑ùÂÜÖÈÉ®Á©∫ËÖî‰∏ñÁïåÔºåÊó∂Èó¥‰ªø‰ΩõÂÜªÁªìÔºåÂîØÊúâÂπΩËìùÂÜ∞ÂÖâ‰∏éÊ∑±Êµ∑ÂõûÂìçÔºåÂØÇÈùôËÄåÁ•ûÂú£„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\yongjibingyuan.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\yongjibingyuan.mp4' },
            { id: 'azure_steps', name: 'Ê≤ßÊæú‰∫ëÈò∂', theme: 'cool', themeName: 'ËìùËâ≤ÔºöÂáõÂÜΩ‰∏éÊ∑±ÈÇÉ', color: '#0ea5e9', sec: '#0c4a6e', icon: '‚òÅÔ∏è', desc: 'Êµ∑Ê∞¥Ëí∏ËÖæ‰∏∫ËìùËâ≤‰∫ëÈõæÔºåÂåñ‰ΩúËøûÊé•Â§©Âú∞ÁöÑÊµÅÂä®Èò∂Ê¢Ø„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\canglanyunjie.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\canglanyunjie.mp4' },
            { id: 'tidal_crown', name: 'Ê±êËØ≠‰πãÂÜ†', theme: 'cool', themeName: 'ËìùËâ≤ÔºöÂáõÂÜΩ‰∏éÊ∑±ÈÇÉ', color: '#06b6d4', sec: '#164e63', icon: 'üåä', desc: 'ÊΩÆÊ±êÁ©øËøáÂ§©ÁÑ∂ÂÜ†ÂÜïËà¨ÁöÑÂ±±‰ΩìÔºåÈ∏£ÂìçÂ¶ÇÂ§ßÊµ∑ÂëºÂê∏ÁöÑÈüµÂæã„ÄÇ', image: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\xiyuzhiguan.png', video: 'C:\\Users\\Administrator\\Pictures\\Saved Pictures\\Medium conversion\\xiyuzhiguan.mp4' }
        ];

        let audioCtx, melodyGain, melodyInterval, musicMuted = false, userData = { 
            answers: [], boxIdx: 0, climateIdx: 0, targetIsland: null, 
            tokenFiles: [null, null, null], hasImageToken: false, imageColors: [], 
            bgObjects: [], themeDirection: 'default', destinyNodes: [] 
        };
        let currentStep = -1;
        let bgAnimId = null;

        // ÊãìÊâë‰∫§‰∫íÁä∂ÊÄÅ
        let pendingNodePos = null;
        let pendingNodeType = null;
        let draggedNode = null;
        let baselineNodes = [{x: 52, y: 390}, {x: 468, y: 390}];
        let topologyLoopId = null;

        window.onload = () => {
            const hg = document.getElementById('hourglass-overlay');
            const mask = document.getElementById('init-white-mask');
            const bgCanvas = document.getElementById('deconstructed-bg-canvas');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            requestAnimationFrame(() => { hg.style.opacity = '1'; });
            setTimeout(() => {
                hg.style.opacity = '0'; hg.style.filter = 'blur(20px)';
                if(mask) mask.style.opacity = '0';
                setTimeout(() => { hg.style.display = 'none'; navigateTo(0); }, 1500);
            }, 5000); 
            initStars();
        };

        function unlockAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                melodyGain = audioCtx.createGain();
                melodyGain.gain.setValueAtTime(0, audioCtx.currentTime);
                melodyGain.connect(audioCtx.destination);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function toggleMusic() {
            musicMuted = !musicMuted;
            const onIcon = document.getElementById('music-icon-on');
            const offIcon = document.getElementById('music-icon-off');
            if (melodyGain) {
                if (musicMuted) {
                    melodyGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                    onIcon.classList.add('hidden');
                    offIcon.classList.remove('hidden');
                } else {
                    melodyGain.gain.linearRampToValueAtTime(0.75, audioCtx.currentTime + 1.5);
                    onIcon.classList.remove('hidden');
                    offIcon.classList.add('hidden');
                }
            }
            playClick();
        }

        function startThemeMelody(theme) {
            if (!audioCtx) return;
            if (melodyInterval) clearTimeout(melodyInterval);
            const scales = {
                'warm': [440, 554, 659, 880, 1108],      
                'mystic': [349, 415, 523, 698, 830],    
                'nature': [392, 440, 523, 659, 783],    
                'cool': [523, 659, 783, 1046, 1318]     
            };
            const currentScale = scales[theme] || scales['warm'];
            const type = 'sine'; 
            const playCycle = () => {
                if (musicMuted) return;
                const rootIdx = Math.floor(Math.random() * (currentScale.length - 2));
                const chord = [currentScale[rootIdx], currentScale[rootIdx + 1], currentScale[rootIdx + 2]];
                chord.forEach((freq, i) => {
                    const delay = i * 0.15 + Math.random() * 0.05;
                    const duration = 4.0 + Math.random() * 2.0; 
                    setTimeout(() => playTone(freq, type, duration, 0.12), delay * 1000);
                });
                const nextPulse = 1800 + Math.random() * 1200;
                melodyInterval = setTimeout(playCycle, nextPulse);
            };
            melodyGain.gain.linearRampToValueAtTime(0.75, audioCtx.currentTime + 3);
            playCycle();
        }

        function playTone(freq, type, duration, volume = 0.375) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(0, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(volume, audioCtx.currentTime + 0.8); 
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration); 
            osc.connect(g);
            g.connect(melodyGain);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        window.onresize = () => {
            const bgCanvas = document.getElementById('deconstructed-bg-canvas');
            if (bgCanvas) { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; }
        };

        function triggerUpload(idx) { 
            unlockAudio(); 
            if (userData.tokenFiles[idx]) return; 
            document.getElementById(`upload-${idx}`).click(); 
        }

        async function handleFileChange(idx) {
            const input = document.getElementById(`upload-${idx}`);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                userData.tokenFiles[idx] = file;
                const slot = document.getElementById(`slot-${idx}`);
                slot.classList.add('active'); slot.querySelector('.slot-label').innerText = 'Â∑≤ÊÑüÂ∫î';
                if (file.type.startsWith('image')) {
                    userData.hasImageToken = true; processImageForBackground(file);
                }
                playClick(); 
                updateProceedState();
            }
        }

        async function processImageForBackground(file) {
            const img = new Image(); img.src = URL.createObjectURL(file); await img.decode();
            const offCanvas = document.createElement('canvas'); const offCtx = offCanvas.getContext('2d');
            offCanvas.width = 50; offCanvas.height = 50; offCtx.drawImage(img, 0, 0, 50, 50);
            const pixelData = offCtx.getImageData(0, 0, 50, 50).data;
            const colors = []; let totalR = 0, totalG = 0, totalB = 0;
            for (let i = 0; i < pixelData.length; i += 4) {
                const r = pixelData[i], g = pixelData[i+1], b = pixelData[i+2];
                totalR += r; totalG += g; totalB += b;
                if (i % 20 === 0) colors.push({ r, g, b, a: 0.15 + Math.random() * 0.1 });
            }
            const avgR = totalR / (50*50), avgG = totalG / (50*50), avgB = totalB / (50*50);
            const isWhite = avgR > 210 && avgG > 210 && avgB > 210;
            if (isWhite) { userData.themeDirection = 'cool'; } 
            else if (avgB > avgR && avgB > avgG) { userData.themeDirection = 'cool'; } 
            else if (avgG >= avgR && avgG > avgB) { userData.themeDirection = 'nature'; } 
            else if (avgR > avgG && avgB > avgG) { userData.themeDirection = 'mystic'; } 
            else if (avgR > avgG) { userData.themeDirection = 'warm'; } 
            else { userData.themeDirection = 'mystic'; }
            userData.imageColors = colors; initBackgroundObjects();
        }

        function initBackgroundObjects() {
            const colors = userData.imageColors; userData.bgObjects = []; const count = 150; 
            for(let i=0; i<count; i++) {
                const colorObj = colors[Math.floor(Math.random() * colors.length)];
                const isGrey = Math.random() > 0.8; const gVal = Math.floor((colorObj.r + colorObj.g + colorObj.b) / 3);
                userData.bgObjects.push({
                    x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight,
                    vx: (Math.random() - 0.5) * 0.4, vy: (Math.random() - 0.5) * 0.4,
                    size: 60 + Math.random() * 300, rotation: Math.random() * Math.PI * 2,
                    rotSpeed: (Math.random() - 0.5) * 0.002, type: Math.random(), isGrey,
                    color: isGrey ? `rgba(${gVal+30},${gVal+30},${gVal+30},${colorObj.a})` : `rgba(${colorObj.r},${colorObj.g},${colorObj.b},${colorObj.a})`,
                    stroke: `rgba(255,255,255,${0.15 + Math.random() * 0.15})`
                });
            }
            if(!bgAnimId) startBackgroundAnimation();
        }

        function startBackgroundAnimation() {
            const canvas = document.getElementById('deconstructed-bg-canvas'); const ctx = canvas.getContext('2d');
            const animate = () => {
                if(!userData.hasImageToken) { bgAnimId = null; return; }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                userData.bgObjects.forEach(obj => {
                    obj.x += obj.vx; obj.y += obj.vy; obj.rotation += obj.rotSpeed;
                    if(obj.x < -obj.size) obj.x = canvas.width + obj.size; if(obj.x > canvas.width + obj.size) obj.x = -obj.size;
                    if(obj.y < -obj.size) obj.y = canvas.height + obj.size; if(obj.y > canvas.height + obj.size) obj.y = -obj.size;
                    ctx.save(); ctx.translate(obj.x, obj.y); ctx.rotate(obj.rotation); ctx.fillStyle = obj.color; ctx.strokeStyle = obj.stroke; ctx.lineWidth = 0.8;
                    if (obj.type < 0.3) { ctx.beginPath(); ctx.moveTo(0, -obj.size/2); ctx.lineTo(obj.size/2, obj.size/2); ctx.lineTo(-obj.size/2, obj.size/2); ctx.closePath(); ctx.fill(); ctx.stroke(); } 
                    else if (obj.type < 0.6) { const r = obj.size / 6; ctx.beginPath(); if (ctx.roundRect) ctx.roundRect(-obj.size/2, -obj.size/2, obj.size, obj.size, [r, r, r, r]); else ctx.rect(-obj.size/2, -obj.size/2, obj.size, obj.size); ctx.fill(); ctx.stroke(); } 
                    else if (obj.type < 0.8) { ctx.beginPath(); ctx.ellipse(0, 0, obj.size/2, obj.size/3, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); } 
                    else { ctx.strokeRect(-obj.size/2, -obj.size/2, obj.size, obj.size); }
                    ctx.restore();
                });
                bgAnimId = requestAnimationFrame(animate);
            };
            animate();
        }

        function clearSlot(event, idx) {
            event.stopPropagation(); userData.tokenFiles[idx] = null;
            document.getElementById(`upload-${idx}`).value = "";
            const slot = document.getElementById(`slot-${idx}`);
            slot.classList.remove('active'); slot.querySelector('.slot-label').innerText = 'ÊäïÊîæÁîüÂëΩ‰ø°Áâ©'; 
            userData.hasImageToken = userData.tokenFiles.some(f => f && f.type.startsWith('image'));
            if (!userData.hasImageToken) { const canvas = document.getElementById('deconstructed-bg-canvas'); if(canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); }
            playClick(); updateProceedState();
        }

        function updateProceedState() { const hasToken = userData.tokenFiles.some(f => f !== null); document.getElementById('proceed-trigger').classList.toggle('ready', hasToken); }

        function navigateTo(s, direction = 'out') {
            const isGoingBack = direction === 'back';
            const curContainer = document.querySelector(`.step-container.active`);
            if (curContainer) curContainer.classList.remove('active');
            if (currentStep !== -1) triggerRipple(isGoingBack ? 'in' : 'out'); 
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.opacity = s >= 4 ? '0' : '1';
            for(let i=0; i<4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                dot.classList.remove('active', 'completed');
                if (i === s) dot.classList.add('active'); else if (i < s) dot.classList.add('completed');
            }
            if (s === 4 && !isGoingBack) setTimeout(startDestinyBubbles, 800); 
            
            if (s === 4 && !userData.targetIsland) {
                const answer = userData.answers[0];
                const mapping = {
                    'ÁÜîÁÅ´Ê∑¨ÂÖµ': 'ember_island', 'ÁÑöÈ£éËØïÁÇº': 'ember_island',
                    'ÈéèÈáëÁ∫πË∫´': 'maple_cliff', 'Ëµ§Êû´Ë°ÄË™ì': 'maple_cliff',
                    'ÁªáÊ¢¶È¶ôÊ∞õ': 'dream_mist', 'ÈõæÊµ∑ÂØªÁúü': 'dream_mist',
                    'ÁÅµÊ±êÂêåÈ¢ë': 'violet_valley',
                    'ÊòüÊòôÁ•àÊÑø': 'starry_field',
                    'Ê†πËÑâËÅÜËÆØ': 'melody_prairie', 'ÂçÉÁ±ÅÂíåÈ∏£': 'melody_prairie',
                    'ÁîüÊú∫ÂèçÂì∫': 'floating_forest', 'ÈõæÂæÑÈóÆÂÆâ': 'floating_forest',
                    'ÊΩÆÊ±êÊ†°ÂéÜ': 'tidal_crown', 'ÂáùÈõæÂ°ëÂΩ¢': 'tidal_crown',
                    '‰∫ëÈò∂ÁåÆÁ•≠': 'azure_steps',
                    'Ê∏äÁû≥Â∑°Á§º': 'ice_abyss'
                };
                const targetId = mapping[answer] || 'ember_island';
                userData.targetIsland = islandTypes.find(t => t.id === targetId);
            }

            const canvasBg = document.getElementById('bg-canvas'), finalBg = document.getElementById('bg-final'), step0Bg = document.getElementById('step0-bg'), deconstructedBg = document.getElementById('deconstructed-bg-canvas');
            if (s === 0) { canvasBg.style.opacity = '1'; setTimeout(() => { step0Bg.classList.add('show-bg'); }, 1000); } 
            else { step0Bg.classList.remove('show-bg'); }
            if (userData.hasImageToken && s >= 1 && s <= 3) deconstructedBg.style.opacity = '1'; else deconstructedBg.style.opacity = '0';
            if (s === 4) {
                const isl = userData.targetIsland || islandTypes[0];
                finalBg.style.background = `linear-gradient(135deg, #f8fafc 0%, #f1f5f9 40%, ${isl.color}77 100%)`;
                finalBg.style.opacity = '1'; canvasBg.style.opacity = '0'; document.body.classList.add('light-mode');
                startThemeMelody(isl.theme);
                document.getElementById('music-toggle').classList.add('visible');
            } else { 
                finalBg.style.opacity = '0'; if (s !== 0) canvasBg.style.opacity = '1'; 
                document.body.classList.remove('light-mode'); 
                if (s < 4) { 
                    userData.targetIsland = null; 
                    document.getElementById('bubble-container').innerHTML = ''; 
                    if(melodyInterval) { clearTimeout(melodyInterval); melodyInterval = null; }
                    if(melodyGain) melodyGain.gain.setValueAtTime(0, audioCtx.currentTime);
                    document.getElementById('music-toggle').classList.remove('visible');
                    const container = document.getElementById('reified-image');
                    container.innerHTML = '';
                    container.classList.add('opacity-0');
                    document.getElementById('reify-btn').classList.remove('hidden');
                    document.getElementById('stereo-btn').classList.add('hidden');
                    document.getElementById('cancel-stereo-btn').classList.add('hidden');
                    document.getElementById('island-visual').style.opacity = 1;
                    if(topologyLoopId) cancelAnimationFrame(topologyLoopId);
                } 
            }
            setTimeout(() => {
                document.querySelectorAll('.step-container').forEach(c => { c.style.display = 'none'; c.classList.remove('active'); });
                const container = document.getElementById(`step-${s}`);
                if (!container) return;
                container.style.display = 'flex';
                void container.offsetWidth; 
                requestAnimationFrame(() => { container.classList.add('active'); });
                currentStep = s;
                document.getElementById(`global-back`).classList.toggle('hidden', s === 0);
                if (s === 1) initClimate(); if (s === 2) initTopology(); if (s === 3) initAltar(); if (s === 4) showResult();
            }, isGoingBack ? 1000 : 550); 
        }

        function showLoading(cb) {
            const l = document.getElementById('loading-overlay');
            l.style.display = 'flex'; l.style.opacity = '0'; l.style.filter = 'blur(15px)';
            l.offsetHeight; l.style.transition = 'opacity 0.6s ease, filter 0.6s ease'; l.style.opacity = '1'; l.style.filter = 'blur(0px)';
            setTimeout(() => {
                l.style.transition = 'opacity 0.4s ease-in, filter 0.4s ease-in'; l.style.opacity = '0'; l.style.filter = 'blur(25px)';
                setTimeout(() => { l.style.display = 'none'; cb(); }, 400);
            }, 1200);
        }

        function processStep(s) { unlockAudio(); playClick(); showLoading(() => navigateTo(s + 1)); }

        function initClimate() {
            const themeConfigs = {
                'warm': { title: 'ÁÇΩÁÉà‰∏éÁªöÁÉÇ', opts: [{ name: 'ÁÜîÁÅ´Ê∑¨ÂÖµ', desc: 'ÂºïÁÜîÂ≤©ÂÖ•Âú∞ËÑâÔºåÈîªÈÄ†‰∏çÊúΩÁ•ûÂÖµ„ÄÇ' }, { name: 'ÁÑöÈ£éËØïÁÇº', desc: 'Á©øË∂äÁÇôÁÉ≠Ê≤ôÊµ∑ÔºåÂÆåÊàêÊàêÂπ¥Á§º„ÄÇ' }, { name: 'ÈéèÈáëÁ∫πË∫´', desc: '‰ª•ÁüøÂ≤©ÈáëÁ≤âÁ∫πË∫´ÔºåÈì≠ÂàªÂäüÂãã„ÄÇ' }, { name: 'Ëµ§Êû´Ë°ÄË™ì', desc: 'È•ÆËµ§Êû´Ë°ÄÈú≤ÔºåÁ´ãÊ∞∏ÊÅíË™ìË®Ä„ÄÇ' }] },
                'mystic': { title: 'Ê¢¶Âπª‰∏éÂπΩÁßò', opts: [{ name: 'ÁªáÊ¢¶È¶ôÊ∞õ', desc: 'Ë∞ÉÈ¶ôÂÖ•Ê¢¶ÔºåÂÖ±Ëµ¥È¢ÑË®ÄÂπªÂ¢É„ÄÇ' }, { name: 'ÈõæÊµ∑ÂØªÁúü', desc: 'Êí§ÂéªË∑ØÊ†áÔºåÂá≠ÁÅµËßâËµ∞Âá∫Ëø∑ÈÄî„ÄÇ' }, { name: 'ÁÅµÊ±êÂêåÈ¢ë', desc: 'ÈùôÂùêËä±Êµ∑ÔºåÂêåÊ≠•ÁîüÂëΩÊ≥¢Âä®„ÄÇ' }, { name: 'ÊòüÊòôÁ•àÊÑø', desc: 'ÂÄüÊòôËä±ÊòüËæâÔºåËÆ©ÊÑøÊúõ‰∏äËææÂ§©Âê¨„ÄÇ' }] },
                'nature': { title: 'ÁîüÊú∫‰∏éÁßòÂ¢É', opts: [{ name: 'Ê†πËÑâËÅÜËÆØ', desc: 'ËÄ≥Ë¥¥Âè§Ê†ëÔºåÂê¨ÂèñÂ§ßÂú∞ÁÆ¥Ë®Ä„ÄÇ' }, { name: 'ÂçÉÁ±ÅÂíåÈ∏£', desc: '‰ª•ËçâÊú®‰∏∫Âô®Ôºå‰∏éÈ£éÂÖ±Â•è„ÄÇ' }, { name: 'ÁîüÊú∫ÂèçÂì∫', desc: '‰∏∫Êñ∞ÁîüÂëΩÁßç‰∏ãÂØπÂ∫îÊ£ÆÊûó„ÄÇ' }, { name: 'ÈõæÂæÑÈóÆÂÆâ', desc: 'ÈöèÈõæÊé¢ÁßòÔºåÈóÆÂÄôÊú™Áü•ÁîüÁÅµ„ÄÇ' }] },
                'cool': { title: 'ÂáõÂÜΩ‰∏éÊ∑±ÈÇÉ', opts: [{ name: 'ÊΩÆÊ±êÊ†°ÂéÜ', desc: 'Âê¨Ê±êÂ£∞Ëæ®Êó∂ËäÇÔºåÊ†°ÂáÜÂéÜÊ≥ï„ÄÇ' }, { name: '‰∫ëÈò∂ÁåÆÁ•≠', desc: 'Áôª‰∫ëÈõæÈò∂Ê¢ØÔºåÁåÆÁ•≠‰ª•Ê±ÇÊô∫ÊÖß„ÄÇ' }, { name: 'Ê∏äÁû≥Â∑°Á§º', desc: 'ÁªïË°å‰πãÊ∏äËà™Ë°åÔºåÁ∫™Âøµ‰∏éÊ≤âÊÄù„ÄÇ' }, { name: 'ÂáùÈõæÂ°ëÂΩ¢', desc: 'ÊçïÈõæÂáùÂÜ∞ÈõïÔºåÁ§ºÊàêÂç≥Ê∂àÊï£„ÄÇ' }] }
            };
            const currentConfig = themeConfigs[userData.themeDirection] || themeConfigs['warm'];
            const questionEl = document.getElementById('climate-question');
            questionEl.innerText = `ÂΩìÂâçÊÑüÂ∫îÔºö${currentConfig.title}„ÄÇËØ∑ÈÄâÊã©ÊÇ®ÁöÑ‰ª™ÂºèË°å‰∏∫Ôºö`;
            const box = document.getElementById('climate-options');
            box.innerHTML = '';
            currentConfig.opts.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full py-5 px-8 border border-white/10 rounded-full hover:bg-white hover:text-slate-900 transition-all text-left bg-white/5 backdrop-blur-sm shadow-lg group relative overflow-hidden";
                btn.innerHTML = `<div class="flex flex-col gap-1 relative z-10"><span class="text-[13px] tracking-widest font-bold uppercase">${opt.name}</span><span class="text-[10px] opacity-50 group-hover:opacity-100 transition-opacity">${opt.desc}</span></div><div class="absolute right-6 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-20 transition-all text-2xl">‚ú®</div>`;
                btn.onclick = () => { playClick(); userData.answers[0] = opt.name; userData.climateIdx = idx; navigateTo(2); };
                box.appendChild(btn);
            });
        }

        // ‰øÆÊîπÁÇπ 3Ôºö‰∫∫ÁîüÂú∞ÂΩ¢ÈÄªËæëÂçáÁ∫ß - Â¢ûÂä†È´òÂ§ÑÊÑüÂ∫î‰∏éÂÆûÊó∂ÂêåÊ≠•ÂëºÂê∏
        function initTopology() {
            const svg = document.getElementById('topology-svg'); 
            const hint = document.getElementById('topology-hint'); 
            const btn = document.getElementById('topo-activate-btn');
            const menu = document.getElementById('topology-menu');
            if(!svg) return; 
            
            svg.innerHTML = ''; 
            userData.destinyNodes = []; 
            hint.style.opacity = '1';
            menu.style.display = 'none';
            btn.className = "px-20 py-5 bg-white/5 border border-white/10 text-white/20 rounded-full text-[10px] tracking-[0.8em] font-bold uppercase transition-all shadow-xl pointer-events-none";

            const baselinePath = document.createElementNS("http://www.w3.org/2000/svg", "line");
            baselinePath.setAttribute("x1", baselineNodes[0].x); baselinePath.setAttribute("y1", baselineNodes[0].y);
            baselinePath.setAttribute("x2", baselineNodes[1].x); baselinePath.setAttribute("y2", baselineNodes[1].y);
            baselinePath.setAttribute("stroke", "white"); baselinePath.setAttribute("stroke-opacity", "0.3");
            baselinePath.setAttribute("stroke-width", "1"); baselinePath.setAttribute("stroke-dasharray", "4,4");
            svg.appendChild(baselinePath);

            baselineNodes.forEach(node => {
                const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                c.setAttribute("cx", node.x); c.setAttribute("cy", node.y); c.setAttribute("r", 3);
                c.setAttribute("fill", "white"); c.setAttribute("fill-opacity", "0.5");
                svg.appendChild(c);
            });

            svg.onmousedown = (e) => { 
                if (draggedNode) return;
                const rect = svg.getBoundingClientRect(); 
                const x = e.clientX - rect.left; 
                const y = e.clientY - rect.top; 
                
                if (e.target.tagName === 'svg' || e.target.tagName === 'line') {
                    if(menu.style.display === 'flex') {
                        closeTopologyMenu();
                    } else {
                        pendingNodePos = { x, y };
                        menu.classList.remove('menu-hiding');
                        menu.style.display = 'flex';
                        menu.style.left = `${e.clientX}px`;
                        menu.style.top = `${e.clientY}px`;
                        document.getElementById('topology-input-area').style.display = 'none';
                        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('selected'));
                        playClick();
                    }
                }
            };

            window.addEventListener('mousemove', handleNodeDrag);
            window.addEventListener('mouseup', handleNodeDragEnd);

            // ‰øÆÊîπÁÇπ 3ÔºöÁâ©ÁêÜ Tick - ÂÆûÁé∞È´òÂ§ÑÂèò‰∫Æ‰∏éÂêåÊ≠•ÁºìÂä®
            const tick = () => {
                const time = Date.now() * 0.001;
                userData.destinyNodes.forEach(node => {
                    // ÊûúÂÜªÂª∂ËøüË∑üÈöèÁÆóÊ≥ï (lerp)
                    node.currentX += (node.targetX - node.currentX) * 0.12;
                    node.currentY += (node.targetY - node.currentY) * 0.12;

                    // ËÆ°ÁÆóÂëºÂê∏ÂÅèÁßªÈáè
                    const breathScale = 1 + Math.sin(time * 1.5) * 0.04;
                    const breathY = Math.sin(time * 1.2) * 2.5;

                    // ËÆ°ÁÆóÈ´òÂ∫¶Á≥ªÊï∞ (0.0 Â∫ïÈÉ® -> 1.0 È°∂ÈÉ®)
                    const altitude = Math.max(0, (520 - node.currentY) / 520);
                    
                    // ‰øÆÊîπÁÇπ 3ÔºöË∂äÂæÄ‰∏äË∂äÂ§ßË∂ä‰∫Æ
                    const finalScale = (0.75 + altitude * 0.5) * breathScale;
                    const finalBrightness = 0.8 + altitude * 1.2;
                    const glowSize = altitude * 18;
                    const lineWidth = 0.6 + altitude * 2.8;

                    // Â∫îÁî®ÂèòÊç¢Âà∞ÁªÑ
                    node.group.setAttribute("transform", `translate(${node.currentX}, ${node.currentY + breathY}) scale(${finalScale})`);
                    node.group.style.filter = `brightness(${finalBrightness}) drop-shadow(0 0 ${glowSize}px rgba(255,255,255,0.4))`;
                    
                    // ‰øÆÊîπÁÇπ 4ÔºöËøûÁ∫øËµ∑ÁÇπÂêåÊ≠•ÁºìÂä®
                    node.lines.forEach(line => {
                        line.setAttribute("x1", node.currentX);
                        line.setAttribute("y1", node.currentY + breathY);
                        line.setAttribute("stroke-width", lineWidth);
                        line.setAttribute("stroke-opacity", 0.15 + altitude * 0.4);
                    });
                });
                topologyLoopId = requestAnimationFrame(tick);
            };
            tick();
        }

        function closeTopologyMenu() {
            const menu = document.getElementById('topology-menu');
            menu.classList.add('menu-hiding');
            setTimeout(() => { menu.style.display = 'none'; menu.classList.remove('menu-hiding'); }, 300);
        }

        function prepareDestinyNode(type) {
            pendingNodeType = type;
            playClick();
            const area = document.getElementById('topology-input-area');
            const prompt = document.getElementById('topology-input-prompt');
            const field = document.getElementById('topology-input-field');
            area.style.display = 'flex';
            field.value = '';
            field.focus();
            const prompts = {
                'circle': 'Êúâ‰ªÄ‰πà‰∫∫Êàñ‰∫ãÁâ©Èô™‰º¥‰∫Ü‰Ω†Ôºü',
                'star': 'Êúâ‰ªÄ‰πà‰∫∫Êàñ‰∫ãÁâ©ÂêØÂèë‰∫Ü‰Ω†Ôºü',
                'triangle': 'Êúâ‰ªÄ‰πà‰∫∫Êàñ‰∫ãÁâ©ÊøÄÂä±‰∫Ü‰Ω†Ôºü',
                'quad': 'Êúâ‰ªÄ‰πà‰∫∫Êàñ‰∫ãÁâ©Ê≤ªÊÑà‰∫Ü‰Ω†Ôºü',
                'harm': 'Êúâ‰ªÄ‰πà‰∫∫Êàñ‰∫ãÁâ©‰º§ÂÆ≥Ëøá‰Ω†Ôºü',
                'custom': 'ËøòÊúâ‰ªÄ‰πàÂõûÂøÜÊàñÈÅ≠ÈÅáÂë¢Ôºü'
            };
            prompt.innerText = prompts[type] || 'ÈïåÂàªÊÑüÊÇü...';
            document.querySelectorAll('.menu-item').forEach(m => {
                const labelText = m.querySelector('.label').innerText;
                const matchMap = {'Èô™‰º¥':'circle', 'ÂêØÂèë':'star', 'ÊøÄÂä±':'triangle', 'Ê≤ªÊÑà':'quad', '‰º§ÂÆ≥':'harm', 'Ëá™ÂÆö‰πâ':'custom'};
                m.classList.toggle('selected', matchMap[labelText] === type);
            });
        }

        function finalizeDestinyNode() {
            const svg = document.getElementById('topology-svg');
            const hint = document.getElementById('topology-hint');
            const btn = document.getElementById('topo-activate-btn');
            const textContent = document.getElementById('topology-input-field').value || 'Êú™ÂëΩÂêçÁöÑÁóïËøπ';
            if (!pendingNodePos || !pendingNodeType) return;
            const { x, y } = pendingNodePos;
            hint.style.opacity = '0';
            closeTopologyMenu();
            playClick();

            const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            group.setAttribute("class", "topology-node-group");
            
            const lines = baselineNodes.map(base => {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x); line.setAttribute("y1", y);
                line.setAttribute("x2", base.x); line.setAttribute("y2", base.y);
                line.setAttribute("stroke", "white"); line.setAttribute("stroke-opacity", "0.2");
                line.setAttribute("stroke-width", "0.8");
                svg.insertBefore(line, svg.firstChild);
                return line;
            });

            let shape; // ‰øÆÊîπÁÇπ 1ÔºöÂõæÊ†áÊï¥‰ΩìÁº©Â∞è
            if (pendingNodeType === 'circle') {
                shape = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                shape.setAttribute("cx", 0); shape.setAttribute("cy", 0); shape.setAttribute("r", 4);
            } else if (pendingNodeType === 'star') {
                shape = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                let points = ""; for(let i=0; i<10; i++) { let r = i % 2 === 0 ? 6 : 3; let a = (i * 36) * Math.PI / 180; points += `${r * Math.sin(a)},${-r * Math.cos(a)} `; }
                shape.setAttribute("points", points);
            } else if (pendingNodeType === 'triangle') {
                shape = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                shape.setAttribute("points", "0,-6 -6,6 6,6");
            } else if (pendingNodeType === 'quad') {
                shape = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                shape.setAttribute("x", -4.5); shape.setAttribute("y", -4.5); shape.setAttribute("width", 9); shape.setAttribute("height", 9); shape.setAttribute("rx", 2);
            } else if (pendingNodeType === 'harm') {
                shape = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                shape.setAttribute("points", "0,6 -6,-6 6,-6");
            } else if (pendingNodeType === 'custom') {
                shape = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                shape.setAttribute("points", "0,-6 -4.5,0 0,6 4.5,0");
            }
            shape.setAttribute("fill", "white");
            shape.setAttribute("class", "topology-node");

            const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
            label.setAttribute("x", 0); label.setAttribute("y", 20);
            label.setAttribute("class", "topology-label-text");
            label.textContent = textContent;

            group.appendChild(shape);
            group.appendChild(label);
            svg.appendChild(group);

            const nodeObj = { targetX: x, targetY: y, currentX: x, currentY: y, type: pendingNodeType, text: textContent, group, lines };
            userData.destinyNodes.push(nodeObj);
            
            group.onmousedown = (e) => { e.stopPropagation(); draggedNode = nodeObj; playClick(); };

            if (userData.destinyNodes.length >= 3) btn.className = "px-20 py-5 bg-white/95 text-slate-900 rounded-full text-[10px] tracking-[0.8em] font-bold uppercase hover:scale-105 transition-all shadow-xl pointer-events-auto cursor-pointer";
            pendingNodePos = null; pendingNodeType = null;
        }

        // ‰øÆÊîπÁÇπ 4ÔºöÂâØÊú¨ËΩ¨Âú∫ÂÜÖÂÆπÊèêÂèñÈÄªËæë‰øÆÂ§ç
        function triggerStep2Process() {
            const specials = userData.destinyNodes.filter(n => n.type === 'harm' || n.type === 'custom');
            if (specials.length > 0) {
                const overlay = document.getElementById('note-transition-overlay');
                const content = document.getElementById('note-content');
                // ‰øÆÂ§çÊñáÊú¨ÊãºÊé•ÈÄªËæë
                content.innerText = specials.map(s => s.text).join(' ¬∑ ');
                overlay.style.display = 'flex';
                setTimeout(() => { overlay.style.opacity = '1'; overlay.style.backdropFilter = 'blur(15px)'; }, 50);
            } else {
                processStep(2);
            }
        }

        function washMemory() {
            const note = document.getElementById('destiny-note');
            const wave = document.getElementById('wave-path');
            const svg = document.querySelector('.wave-svg');
            playClick();
            svg.style.height = '100%';
            wave.innerHTML = `<animate attributeName="d" dur="2s" repeatCount="1" fill="freeze" values="M0,100 C150,100 250,100 400,100 L400,100 L0,100 Z; M0,50 C150,0 250,100 400,50 L400,0 L0,0 Z; M0,0 C150,0 250,0 400,0 L400,0 L0,0 Z" />`;
            setTimeout(() => { note.style.opacity = '0'; note.style.transform = 'translateY(40px) scale(0.9)'; }, 1500);
            setTimeout(() => finishNoteTransition(), 3000);
        }

        function lightMemory() {
            const note = document.getElementById('destiny-note');
            playClick();
            note.style.boxShadow = "0 0 120px 40px rgba(255,255,255,0.9)";
            note.style.background = "#fff";
            setTimeout(() => {
                note.style.opacity = '0';
                note.style.transform = 'scale(1.4) rotate(0deg)';
                triggerRipple('out');
            }, 800);
            setTimeout(() => finishNoteTransition(), 2200);
        }

        function finishNoteTransition() {
            const overlay = document.getElementById('note-transition-overlay');
            overlay.style.opacity = '0';
            overlay.style.filter = 'blur(30px)';
            setTimeout(() => { 
                overlay.style.display = 'none'; 
                // ËøòÂéüÁä∂ÊÄÅ‰ª•‰æø‰∏ãÊ¨°‰ΩøÁî®
                const svg = document.querySelector('.wave-svg');
                svg.style.height = '0';
                document.getElementById('destiny-note').style.cssText = '';
                processStep(2); 
            }, 1000);
        }

        function handleNodeDrag(e) {
            if (!draggedNode) return;
            const svg = document.getElementById('topology-svg');
            const rect = svg.getBoundingClientRect();
            draggedNode.targetX = Math.max(20, Math.min(500, e.clientX - rect.left));
            draggedNode.targetY = Math.max(20, Math.min(500, e.clientY - rect.top));
        }

        function handleNodeDragEnd() {
            if (draggedNode) {
                draggedNode = null;
                playClick();
            }
        }

        function initAltar() {
            const ring = document.getElementById('altar-ring'); ring.innerHTML = '';
            const items = [{n:'Êó†',i:'‚óã'},{n:'ÂõûÂìç',i:'‚óé'},{n:'ÊòüÁÅ´',i:'‚öπ'},{n:'ÊΩÆÊ±ê',i:'‚âà'},{n:'Ê∫êÂ§¥',i:'‚ñ°'},{n:'ÂæãÂä®',i:'‚àÜ'}];
            items.forEach((item, i) => {
                const angle = (i * 360) / items.length;
                const x = Math.cos((angle * Math.PI) / 180) * 280, y = Math.sin((angle * Math.PI) / 180) * 280;
                const box = document.createElement('div');
                box.className = "absolute group cursor-pointer flex flex-col items-center gap-5 transition-all"; box.style.left = '50%'; box.style.top = '50%';
                box.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                box.innerHTML = `<div class="w-24 h-24 bg-white/[0.04] border border-white/10 rounded-[2.5rem] flex items-center justify-center group-hover:bg-white transition-all shadow-2xl"><span class="text-4xl text-white/30 group-hover:text-slate-900 transition-colors">${item.i}</span></div><span class="text-[10px] tracking-[1em] text-white/20 uppercase pl-[1em] font-light">${item.n}</span>`;
                box.onclick = () => { playClick(); userData.boxIdx = i; showLoading(() => navigateTo(4)); };
                ring.appendChild(box);
            });
        }

        function showResult() {
            const isl = userData.targetIsland || islandTypes[0];
            document.getElementById('island-name').innerText = isl.name;
            document.getElementById('island-theme-label').innerText = isl.themeName;
            document.getElementById('island-desc').innerText = isl.desc;
            document.getElementById('island-coord').innerText = `${Math.floor(Math.random()*180)}¬∞E, ${Math.floor(Math.random()*90)}¬∞N`;
            document.getElementById('island-spirit').innerText = ['Ê¥ªË∑É', 'ÈùôË∞ß', 'ÁãÇÂçö', 'Â§çËãè'][Math.floor(Math.random()*4)];
            renderIslandSVG(isl);
        }

        function renderIslandSVG(isl) {
            const vis = document.getElementById('island-visual'); vis.style.opacity = 1;
            vis.innerHTML = `<svg viewBox="0 0 240 240" class="w-[480px] h-[480px] drop-shadow-[0_80px_120px_rgba(0,0,0,0.2)]"><defs><linearGradient id="g-base" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color: ${isl.color}" /><stop offset="100%" style="stop-color: ${isl.sec}" /></linearGradient></defs><path d="M40,160 Q120,205 200,160 L180,215 Q120,240 60,215 Z" fill="url(#g-base)" /><ellipse cx="120" cy="160" rx="90" ry="12" fill="${isl.color}" fill-opacity="0.9" /><g><path d="M80,160 L120,50 L160,160 Z" fill="${isl.color}" fill-opacity="0.6" /><path d="M120,160 L155,20 L195,160 Z" fill="${isl.color}" fill-opacity="0.3" /></g><text x="120" y="100" font-size="65" text-anchor="middle" dominant-baseline="middle">${isl.icon}</text></svg>`;
        }

        async function reifyStageOne(isCancel = false) {
            const reifyBtn = document.getElementById('reify-btn');
            const stereoBtn = document.getElementById('stereo-btn');
            const cancelBtn = document.getElementById('cancel-stereo-btn');
            const isl = userData.targetIsland || islandTypes[0];
            const targetImagePath = isl.image;
            const container = document.getElementById('reified-image');
            if(!isCancel) { playClick(); reifyBtn.innerText = "‚ú® Ê≠£Âú®ÊÑüÁü•ÁîªÂç∑..."; }
            setTimeout(() => {
                let img = container.querySelector('img');
                if(!img) { img = document.createElement('img'); img.className = "media-layer opacity-0"; img.src = targetImagePath; container.appendChild(img); }
                img.onload = () => {
                    document.getElementById('island-visual').style.opacity = 0; container.classList.remove('opacity-0'); img.style.opacity = "1";
                    const video = container.querySelector('video');
                    if(video) { video.pause(); video.src = ""; video.load(); video.style.opacity = "0"; setTimeout(() => video.remove(), 2000); }
                    reifyBtn.classList.add('hidden'); stereoBtn.classList.remove('hidden'); cancelBtn.classList.add('hidden');
                };
                if(isCancel) {
                    img.style.opacity = "1";
                    const video = container.querySelector('video');
                    if(video) { video.pause(); video.src = ""; video.load(); video.style.opacity = "0"; setTimeout(() => video.remove(), 2000); }
                    reifyBtn.classList.add('hidden'); stereoBtn.classList.remove('hidden'); cancelBtn.classList.add('hidden');
                }
            }, isCancel ? 0 : 1500);
        }

        async function reifyStageTwo() {
            playClick();
            const stereoBtn = document.getElementById('stereo-btn');
            const cancelBtn = document.getElementById('cancel-stereo-btn');
            const isl = userData.targetIsland || islandTypes[0];
            const targetVideoPath = isl.video;
            const container = document.getElementById('reified-image');
            stereoBtn.innerText = "üåÄ Ê≠£Âú®Á´ã‰ΩìÂåñ...";
            
            setTimeout(() => {
                let video = container.querySelector('video');
                if(!video) {
                    video = document.createElement('video');
                    video.className = "media-layer opacity-0";
                    video.src = targetVideoPath;
                    video.loop = true; video.muted = false; video.volume = 1.0; video.playsInline = true;
                    container.appendChild(video);
                }
                video.currentTime = 0;
                video.pause();
                video.oncanplay = () => {
                    video.style.opacity = "1";
                    const img = container.querySelector('img');
                    if(img) img.style.opacity = "0";
                    setTimeout(() => { video.play(); }, 2200);
                    stereoBtn.classList.add('hidden');
                    stereoBtn.innerText = "üåÄ Á´ã‰ΩìÂåñÁîªÂç∑";
                    cancelBtn.classList.remove('hidden');
                };
            }, 1200);
        }

        function goBack() { playClick(); if (currentStep > 0) navigateTo(currentStep - 1, 'back'); }
        function reset() { location.reload(); }
        function showError(m) { const mod = document.getElementById('error-modal'); document.getElementById('error-text').innerText = m; mod.classList.add('show'); setTimeout(() => mod.classList.remove('show'), 4000); }

        function triggerRipple(direction = 'out') {
            const container = document.getElementById('ripple-container'); playRippleSound();
            for(let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const rip = document.createElement('div'); rip.className = 'ripple';
                    const size = 100 + (i * 60); rip.style.width = size + 'px'; rip.style.height = size + 'px';
                    rip.style.animation = `${direction === 'out' ? 'ripple-out' : 'ripple-in'} ${direction === 'out' ? 2.2 : 1.4}s forwards`;
                    container.appendChild(rip); setTimeout(() => rip.remove(), 2500);
                }, i * 200); 
            }
        }

        function startDestinyBubbles() {
            const container = document.getElementById('bubble-container'); container.innerHTML = ''; const startTime = Date.now();
            const spawn = () => {
                const elapsed = Date.now() - startTime; if (elapsed > 5000 || currentStep < 4) return;
                const ratio = 1 - (elapsed / 5000); const batchSize = Math.ceil(ratio * 8); 
                for(let i=0; i < batchSize; i++) {
                    const b = document.createElement('div'); b.className = 'bubble';
                    const size = Math.random() * (110 * ratio + 30) + 20; const left = Math.random() * 100;
                    const riseDuration = Math.random() * 3 + 3.5; const sway = (Math.random() - 0.5) * 220;
                    const blurValue = Math.random() * 6 + 2; b.style.width = `${size}px`; b.style.height = `${size}px`; b.style.left = `${left}%`;
                    b.style.filter = `blur(${blurValue}px)`; b.style.setProperty('--sway', `${sway}px`); 
                    b.style.animation = `bubble-rise ${riseDuration}s cubic-bezier(0.4, 0, 0.2, 1) forwards`;
                    container.appendChild(b); setTimeout(() => { if(b.parentNode) b.remove(); }, riseDuration * 1000);
                }
                setTimeout(spawn, 90 + (1 - ratio) * 500);
            };
            spawn();
        }

        function playRippleSound() {
            if (!audioCtx) return;
            const duration = 1.8, now = audioCtx.currentTime;
            const bufferSize = audioCtx.sampleRate * duration, buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass';
            filter.frequency.setValueAtTime(600, now); filter.frequency.exponentialRampToValueAtTime(300, now + duration);
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.5, now + 0.3); gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start(now); noise.stop(now + duration);
        }

        function playClick() { 
            if (!audioCtx) return; 
            const osc = audioCtx.createOscillator(), g = audioCtx.createGain(); 
            osc.frequency.setValueAtTime(1500, audioCtx.currentTime); 
            g.gain.setValueAtTime(0.1, audioCtx.currentTime); 
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15); 
            osc.connect(g); g.connect(audioCtx.destination); 
            osc.start(); osc.stop(audioCtx.currentTime + 0.15); 
        }

        function initStars() { const group = document.getElementById('stars-group'); for(let i=0; i<100; i++) { const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle"); circle.setAttribute("cx", Math.random() * 1000); circle.setAttribute("cy", Math.random() * 400); circle.setAttribute("r", Math.random() * 1.5); circle.setAttribute("fill", "white"); circle.setAttribute("opacity", Math.random()); group.appendChild(circle); } }
    </script>
</body>
</html>